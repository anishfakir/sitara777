class AdminPanelApp{constructor(){this.currentSection="dashboard";this.sections=["dashboard","bazaars","bets","results","users","transactions","audit"];this.sectionTitles={"dashboard":"Dashboard","bazaars":"Bazaar Management","bets":"Bet Management","results":"Results Management","users":"Users Management","transactions":"Transactions","audit":"Audit Logs"};this.managers={};this.init()}init(){this.checkAuth();this.bindEvents();this.initializeManagers();this.loadUserInfo();this.showSection(this.currentSection);console.log("ðŸš€ Sitara777 Admin Panel initialized")}async checkAuth(){auth.onAuthStateChanged(async(user)=>{if(user){console.log("User authenticated:",user.email);const isAdmin=await this.checkAdminStatus(user.uid);if(!isAdmin){showAlert("danger","Access denied. Admin privileges required.");await auth.signOut();window.location.href="/login.html"}}else{console.log("User not authenticated, redirecting to login");window.location.href="/login.html"}})}async checkAdminStatus(uid){try{const adminSnapshot=await database.ref(`${DB_PATHS.ADMINS}/${uid}`).once("value");if(adminSnapshot.exists()){const adminData=adminSnapshot.val();if(adminData.isAdmin){sessionStorage.setItem("adminData",JSON.stringify(adminData));return true}}return false}catch(error){console.error("Error checking admin status:",error);return false}}bindEvents(){document.querySelectorAll("[data-section]").forEach(link=>{link.addEventListener("click",(e)=>{e.preventDefault();const section=e.currentTarget.getAttribute("data-section");this.showSection(section)})});const menuToggle=document.getElementById("menuToggle");const sidebarToggle=document.getElementById("sidebarToggle");const sidebar=document.getElementById("sidebar");const mainContent=document.querySelector(".main-content");if(menuToggle){menuToggle.addEventListener("click",()=>{sidebar.classList.toggle("show")})}if(sidebarToggle){sidebarToggle.addEventListener("click",()=>{sidebar.classList.toggle("collapsed");mainContent.classList.toggle("expanded")})}document.addEventListener("click",(e)=>{if(window.innerWidth<=1200){if(!sidebar.contains(e.target)&&!menuToggle.contains(e.target)){sidebar.classList.remove("show")}}});document.addEventListener("keydown",(e)=>{if((e.ctrlKey||e.metaKey)&&e.key==="k"){e.preventDefault();this.focusSearch()}if((e.ctrlKey||e.metaKey)&&e.key==="r"){e.preventDefault();this.refreshCurrentSection()}if(e.key==="Escape"){const openModals=document.querySelectorAll(".modal.show");openModals.forEach(modal=>{const modalInstance=bootstrap.Modal.getInstance(modal);if(modalInstance)modalInstance.hide()})}});setInterval(()=>{this.refreshCurrentSection()},5*60*1000)}initializeManagers(){this.managers={dashboard:window.dashboardManager,bazaars:window.bazaarManager,bets:window.betManager,results:window.resultsManager,users:window.userManager,transactions:window.transactionManager,audit:window.auditManager};console.log("ðŸ“Š Managers initialized:",Object.keys(this.managers))}loadUserInfo(){const user=auth.currentUser;if(user){const adminData=sessionStorage.getItem("adminData");const adminInfo=adminData?JSON.parse(adminData):{};const userName=document.getElementById("userName");const userEmail=document.getElementById("userEmail");if(userName){userName.textContent=adminInfo.name||user.displayName||"Admin User"}if(userEmail){userEmail.textContent=user.email}}}showSection(sectionName){this.sections.forEach(section=>{const sectionElement=document.getElementById(section+"Section");if(sectionElement){sectionElement.classList.remove("active")}});const selectedSection=document.getElementById(sectionName+"Section");if(selectedSection){selectedSection.classList.add("active")}document.querySelectorAll("[data-section]").forEach(link=>{link.classList.remove("active")});const activeLink=document.querySelector(`[data-section="${sectionName}"]`);if(activeLink){activeLink.classList.add("active")}const pageTitle=document.getElementById("pageTitle");if(pageTitle){pageTitle.textContent=this.sectionTitles[sectionName]||"Admin Panel"}window.location.hash=sectionName;this.currentSection=sectionName;this.loadSectionData(sectionName);console.log(`Switched to ${sectionName} section`)}loadSectionData(sectionName){const manager=this.managers[sectionName];if(manager&&typeof manager.loadData==="function"){manager.loadData()}}refreshCurrentSection(){console.log(`Refreshing ${this.currentSection} section`);this.loadSectionData(this.currentSection)}refreshAllData(){console.log("Refreshing all sections");Object.values(this.managers).forEach(manager=>{if(manager&&typeof manager.loadData==="function"){manager.loadData()}})}focusSearch(){const searchInputs={"bazaars":"bazaarSearchInput","bets":"betSearchInput","results":"resultSearchInput","users":"userSearchInput","transactions":"transactionSearchInput","audit":"auditSearchInput"};const searchId=searchInputs[this.currentSection];if(searchId){const searchInput=document.getElementById(searchId);if(searchInput){searchInput.focus()}}}showAlert(type,message){const alertContainer=document.getElementById("alertContainer");if(alertContainer){const alert=document.createElement("div");alert.className=`alert alert-${type} alert-dismissible fade show`;alert.innerHTML=`<i class="fas fa-${type==="success"?"check-circle":type==="danger"?"exclamation-circle":"info-circle"}"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;alertContainer.appendChild(alert);setTimeout(()=>{if(alert.parentNode){alert.remove()}},5000)}}exportToCSV(data,filename){if(!data||data.length===0){this.showAlert("warning","No data to export");return}const headers=Object.keys(data[0]);const csvContent=[headers.join(","),...data.map(row=>headers.map(header=>`"${row[header]||""}"`).join(","))].join("\\n");const blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"});const link=document.createElement("a");const url=URL.createObjectURL(blob);link.setAttribute("href",url);link.setAttribute("download",`${filename}_${new Date().toISOString().split("T")[0]}.csv`);link.style.visibility="hidden";document.body.appendChild(link);link.click();document.body.removeChild(link)}showModal(modalId){const modal=new bootstrap.Modal(document.getElementById(modalId));modal.show()}hideModal(modalId){const modal=bootstrap.Modal.getInstance(document.getElementById(modalId));if(modal){modal.hide()}}showLoading(elementId){const element=document.getElementById(elementId);if(element){element.innerHTML=`<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div>`}}hideLoading(elementId){const element=document.getElementById(elementId);if(element){element.innerHTML=""}}handleError(error,context=""){console.error(`Error in ${context}:`,error);this.showAlert("danger",`An error occurred: ${error.message}`)}handleSuccess(message){this.showAlert("success",message)}handleWarning(message){this.showAlert("warning",message)}handleInfo(message){this.showAlert("info",message)}}window.showSection=function(sectionName){if(window.adminPanelApp){adminPanelApp.showSection(sectionName)}};window.refreshData=function(){if(window.adminPanelApp){adminPanelApp.refreshCurrentSection()}};window.handleLogout=function(){if(window.authManager){authManager.handleLogout()}};let adminPanelApp;document.addEventListener("DOMContentLoaded",()=>{adminPanelApp=new AdminPanelApp();window.adminPanelApp=adminPanelApp;const hash=window.location.hash.substring(1);if(hash&&adminPanelApp.sections.includes(hash)){adminPanelApp.showSection(hash)}});window.addEventListener("hashchange",()=>{const hash=window.location.hash.substring(1);if(hash&&adminPanelApp&&adminPanelApp.sections.includes(hash)){adminPanelApp.showSection(hash)}});document.addEventListener("visibilitychange",()=>{if(!document.hidden&&adminPanelApp){adminPanelApp.refreshCurrentSection()}});window.addEventListener("resize",()=>{if(window.innerWidth>1200){const sidebar=document.getElementById("sidebar");if(sidebar){sidebar.classList.remove("show")}}});console.log("ðŸŽ¯ Admin Panel App loaded successfully");
